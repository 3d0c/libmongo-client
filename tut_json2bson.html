<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>libmongo-client: JSON to BSON converter</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div class="navpath">
    <ul>
      <li><a class="el" href="tutorial.html">Tutorial</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>JSON to BSON converter </h1>  </div>
</div>
<div class="contents">
<p>Now that we have a basic grasp of the library, we'll write a solution to a real life problem: converting JSON to BSON.</p>
<p>Our program will expect correctly formatted JSON, in condensed one-line format, and will output a BSON document for each line of JSON received.</p>
 <div class="fragment"><pre class="fragment"><span class="preprocessor">#define __STRICT_ANSI__ 1</span>
<span class="preprocessor"></span>
<span class="preprocessor">#include &lt;<a class="code" href="bson_8h.html" title="The BSON API&amp;#39;s public header.">bson.h</a>&gt;</span>
<span class="preprocessor">#include &lt;json.h&gt;</span>

<span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="preprocessor">#include &lt;unistd.h&gt;</span>
<span class="preprocessor">#include &lt;glib.h&gt;</span>
</pre></div></p>
<p>First, we forward declare the json_to_bson() function, because we'll recursively use it later on: <div class="fragment"><pre class="fragment">
<span class="keyword">static</span> bson *json_to_bson (<span class="keyword">struct</span> json_object *json);
</pre></div></p>
<p>Next, we create the heart of the program, a function that takes a BSON object, a value and a key, and appends the key-value pair to the bson object, with the correct type. <div class="fragment"><pre class="fragment">
<span class="keyword">static</span> <span class="keywordtype">void</span>
json_key_to_bson_key (bson *b, <span class="keywordtype">void</span> *val,
                      <span class="keyword">const</span> gchar *key)
{
</pre></div></p>
<p>We do this by checking the JSON object's type, and acting up on it: <div class="fragment"><pre class="fragment">  <span class="keywordflow">switch</span> (json_object_get_type (val))
    {
</pre></div></p>
<p>The boolean, double, integer and string types are easy: we just use the appropriate bson_append_*() function: <div class="fragment"><pre class="fragment">    <span class="keywordflow">case</span> json_type_boolean:
      <a class="code" href="group__bson__append.html#ga6bd3d1aa4e6869c173c3f402d106414a" title="Append a boolean to a BSON object.">bson_append_boolean</a> (b, key, json_object_get_boolean (val));
      <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> json_type_double:
      <a class="code" href="group__bson__append.html#gafd5887727fcd6cdba545acbb0df1a5f4" title="Append a double to a BSON object.">bson_append_double</a> (b, key, json_object_get_double (val));
      <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> json_type_int:
      <a class="code" href="group__bson__append.html#gad5d474c266b6ee9278e339eb78126b00" title="Append a 32-bit integer to a BSON object.">bson_append_int32</a> (b, key, json_object_get_int (val));
      <span class="keywordflow">break</span>;
    <span class="keywordflow">case</span> json_type_string:
      <a class="code" href="group__bson__append.html#ga96b16e53097496dcf333f09d29b04aa8" title="Append a string to a BSON object.">bson_append_string</a> (b, key, json_object_get_string (val), -1);
      <span class="keywordflow">break</span>;
</pre></div></p>
<p>Converting a JSON object to BSON is a bit more complicated, yet, straightforward nevertheless: <div class="fragment"><pre class="fragment">    <span class="keywordflow">case</span> json_type_object:
      {
        bson *sub;

        sub = json_to_bson (val);
        <a class="code" href="group__bson__append.html#gab2673b16bf736e1093fadc32154454be" title="Append a BSON document to a BSON object.">bson_append_document</a> (b, key, sub);
        <a class="code" href="group__bson__object__access.html#ga1c0a306bfbe71d42218a3882ed188dd8" title="Free the memory associated with a BSON object.">bson_free</a> (sub);
        <span class="keywordflow">break</span>;
      }
</pre></div></p>
<p>This is one of the reasons we needed to forward-declare json_to_bson(): we're using it to turn the JSON value into BSON, and append it as a subdocument.</p>
<p>Next up: arrays! This is even trickier than sub-documents, as we need to iterate over the elements, and append each individually. But, trickier as it may be, it's still straightforward; <div class="fragment"><pre class="fragment">    <span class="keywordflow">case</span> json_type_array:
      {
        gint pos;
        bson *sub;

        sub = <a class="code" href="group__bson__object__access.html#ga357437f58074c2dee668a0cae2595b8b" title="Create a new BSON object.">bson_new</a> ();

        <span class="keywordflow">for</span> (pos = 0; pos &lt; json_object_array_length (val); pos++)
          {
            gchar *nk = g_strdup_printf (<span class="stringliteral">&quot;%d&quot;</span>, pos);

            json_key_to_bson_key (sub, json_object_array_get_idx (val, pos),
                                  nk);
            g_free (nk);
          }
        <a class="code" href="group__bson__object__access.html#gaa9919014ef9d2e2c1b04efa31e0f2124" title="Finish a BSON object.">bson_finish</a> (sub);

        <a class="code" href="group__bson__append.html#ga56454238921074e98c1eba40972fe9f3" title="Append a BSON array to a BSON object.">bson_append_array</a> (b, key, sub);
        <a class="code" href="group__bson__object__access.html#ga1c0a306bfbe71d42218a3882ed188dd8" title="Free the memory associated with a BSON object.">bson_free</a> (sub);
        <span class="keywordflow">break</span>;
      }
</pre></div></p>
<p>Anything else, we ignore: <div class="fragment"><pre class="fragment">    <span class="keywordflow">default</span>:
      <span class="keywordflow">break</span>;
</pre></div></p>
<p><div class="fragment"><pre class="fragment">    }
</pre></div></p>
<p><div class="fragment"><pre class="fragment">}
</pre></div></p>
<p>And to bind this together with JSON-C's API, we need two more functions. The first one will simply iterate over a JSON object, and call the function we wrote above: <div class="fragment"><pre class="fragment">
<span class="keyword">static</span> <span class="keywordtype">void</span>
json_to_bson_foreach (bson *b, <span class="keyword">struct</span> json_object *json)
{
  json_object_object_foreach (json, key, val)
    {
      json_key_to_bson_key (b, val, key);
    }
}
</pre></div></p>
<p>The next one is another wrapper around this former: it creates a BSON document, calls the foreach method, then finishes the BSON object and we're done: <div class="fragment"><pre class="fragment">
<span class="keyword">static</span> bson *
json_to_bson (<span class="keyword">struct</span> json_object *json)
{
  bson *b;

  b = <a class="code" href="group__bson__object__access.html#ga357437f58074c2dee668a0cae2595b8b" title="Create a new BSON object.">bson_new</a> ();
  json_to_bson_foreach (b, json);
  <a class="code" href="group__bson__object__access.html#gaa9919014ef9d2e2c1b04efa31e0f2124" title="Finish a BSON object.">bson_finish</a> (b);

  <span class="keywordflow">return</span> b;
}
</pre></div></p>
<p>We're almost done! All that is left is writing our program's entry point: something that will read the input, turn it into BSON, and write it out:</p>
<p><div class="fragment"><pre class="fragment">
<span class="keywordtype">int</span>
main (<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv)
{
  GIOChannel *input;
  GString *json_str;
  GError *error = NULL;
  <span class="keyword">struct </span>json_tokener *tokener;
</pre></div></p>
<p>We do some setting up, creating a new IO channel, and a JSON tokenizer: <div class="fragment"><pre class="fragment">
  input = g_io_channel_unix_new (0);

  json_str = g_string_new (NULL);
  tokener = json_tokener_new ();
</pre></div></p>
<p>Then, until we have something to read... <div class="fragment"><pre class="fragment">
  <span class="keywordflow">while</span> (g_io_channel_read_line_string (input, json_str,
                                        NULL, &amp;error) == G_IO_STATUS_NORMAL)
    {
      <span class="keyword">struct </span>json_object *json;
      bson *bson;
</pre></div></p>
<p>We reset the tokenizer before parsing another line, then parse the JSON we received: <div class="fragment"><pre class="fragment">
      json_tokener_reset (tokener);

      json = json_tokener_parse_ex (tokener, json_str-&gt;str, json_str-&gt;len);
      <span class="keywordflow">if</span> (!json)
        {
          fprintf (stderr, <span class="stringliteral">&quot;Error parsing json: %s\n&quot;</span>, json_str-&gt;str);
          <span class="keywordflow">break</span>;
        }
</pre></div></p>
<p>If we received something other than a JSON object, we can't turn that into BSON, so we write an error to STDERR, and skip this line: <div class="fragment"><pre class="fragment">
      <span class="keywordflow">if</span> (json_object_get_type (json) != json_type_object)
        {
          fprintf (stderr,
                   <span class="stringliteral">&quot;Error: json&#39;s top-level object is not object: %s\n&quot;</span>,
                   json_str-&gt;str);
          json_object_put (json);
          <span class="keywordflow">break</span>;
        }
</pre></div></p>
<p>Otherwise, we turn it into BSON, and write it to STDOUT: <div class="fragment"><pre class="fragment">
      bson = json_to_bson (json);
      json_object_put (json);

      write (1, <a class="code" href="group__bson__object__access.html#ga053d619f59aa8effe973b5b8077fb57b" title="Return the raw bytestream form of the BSON object.">bson_data</a> (bson), <a class="code" href="group__bson__object__access.html#ga57fb6a03f8e9948901945f4b5fc0793c" title="Return the size of a finished BSON object.">bson_size</a> (bson));

      <a class="code" href="group__bson__object__access.html#ga1c0a306bfbe71d42218a3882ed188dd8" title="Free the memory associated with a BSON object.">bson_free</a> (bson);
</pre></div></p>
<p><div class="fragment"><pre class="fragment">    }
</pre></div></p>
<p>And that was our program, a very simple application that turns each line of JSON into BSON.</p>
<p><div class="fragment"><pre class="fragment">
  <span class="keywordflow">return</span> 0;
}
</pre></div> </p>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address class="footer"><small>Generated on Sat Aug 27 2011 13:50:48 for libmongo-client by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
